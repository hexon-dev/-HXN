<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Hexon â€” Referrals</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{
  font-family:'Orbitron',sans-serif;
  background:#071027;
  color:#E6F7FF;
  margin:0;
  padding:18px;
}

.card{
  background:rgba(255,255,255,0.03);
  padding:18px;
  border-radius:12px;
  max-width:820px;
  margin:12px auto;
}

.muted{ color:#9fcbdc; font-size:13px; }

.button{
  padding:10px 14px;
  border-radius:8px;
  background:linear-gradient(90deg,#3b82f6,#22d3ee);
  color:#021125;
  font-weight:700;
  border:0;
  cursor:pointer;
}

.btn-ghost{
  background:transparent;
  border:1px solid rgba(255,255,255,0.06);
  color:#7EE7FF;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
}

nav{
  margin-bottom:8px;
  display:flex;
  gap:8px;
}

nav a{
  color:inherit;
  text-decoration:none;
  padding:6px 10px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.03);
  font-weight:600;
}

input[type="text"]{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.06);
  background:transparent;
  color:inherit;
  box-sizing:border-box;
}

/* simple small toast */
#toast {
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:28px;
  background:rgba(0,0,0,0.7);
  color:#fff;
  padding:8px 12px;
  border-radius:8px;
  font-size:14px;
  display:none;
  z-index:9999;
}
</style>
</head>

<body>

<nav>
  <a href="index.html"><i class="fa-solid fa-gamepad"></i> Game</a>
  <a href="shop.html"><i class="fa-solid fa-mining"></i> Miners</a>
  <a href="leaderboard.html"><i class="fa-solid fa-ranking-star"></i> Leaderboard</a>
  <a href="referrals.html"><i class="fa-solid fa-user-plus"></i> Referrals</a>
</nav>

<div class="card">
  <h2>Invite friends</h2>
  <p class="muted">
    Share this link. It opens the Telegram Mini App directly.
  </p>

  <div style="margin-top:12px;">
    <label class="muted">Your referral link</label>
    <input id="refLink" type="text" readonly />
  </div>

  <div style="display:flex; gap:8px; margin-top:12px;">
    <button id="copyBtn" class="button" type="button">
      <i class="fa-solid fa-copy"></i> Copy link
    </button>

    <button id="shareBtn" class="btn-ghost" type="button">
      <i class="fa-solid fa-share-nodes"></i> Share
    </button>

    <button class="btn-ghost" type="button" id="backBtn">
      <i class="fa-solid fa-arrow-left"></i> Back
    </button>
  </div>

  <div id="status" class="muted" style="margin-top:12px;">
    Loading referral statusâ€¦
  </div>
</div>

<div id="toast"></div>

<script>
/* ================= CONFIG ================= */

const API_BASE = 'https://slot-madonna-identified-arcade.trycloudflare.com';

/* ðŸ”¥ CHANGE THIS */
const TELEGRAM_BOT_USERNAME = 'hxxxnbot';

/* ========================================== */

let clientState = {
  sessionId: localStorage.getItem('hexon_session') || null,
  username: null,
  telegramId: null
};

/* small toast helper */
function showToast(msg, ms = 2000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(t._h);
  t._h = setTimeout(()=> t.style.display = 'none', ms);
}

function api(path, method='GET', body=null){
  return (async ()=>{
    try{
      let url = API_BASE + path;

      if(method === 'GET' && clientState.sessionId){
        url += (url.includes('?') ? '&' : '?') +
          'sessionId=' + encodeURIComponent(clientState.sessionId);
      }

      const headers = {'Content-Type':'application/json'};

      if(clientState.sessionId)
        headers['X-Session-Id'] = clientState.sessionId;

      const opts = {method, headers};

      if(body){
        // attach client info for server convenience
        body = Object.assign({}, body, {
          sessionId: clientState.sessionId,
          username: clientState.username,
          telegramId: clientState.telegramId
        });
        opts.body = JSON.stringify(body);
      }

      const res = await fetch(url, opts);

      // HTTP errors
      if(!res.ok){
        const txt = await res.text();
        console.warn('api error', res.status, txt);
        return null;
      }

      const txt = await res.text();
      return txt ? JSON.parse(txt) : null;

    }catch(e){
      console.warn(e);
      return null;
    }
  })();
}

function initTelegram(){
  if(window.Telegram?.WebApp){
    const tg = window.Telegram.WebApp;
    try { tg.ready(); } catch(e){}
    const user = tg.initDataUnsafe?.user;
    if(user){
      clientState.telegramId = user.id;
      clientState.username =
        user.username ||
        `${user.first_name || ''} ${user.last_name || ''}`.trim();
    }
  }
}

/* ================= REFERRAL ================= */

function buildMiniAppLink(refCode){
  // t.me deep link that opens the bot and (if supported) the mini app
  // keep the same param you used earlier (startapp)
  return `https://t.me/${TELEGRAM_BOT_USERNAME}?startapp=${encodeURIComponent(refCode)}`;
}

async function loadReferral(){

  initTelegram();

  document.getElementById('status').textContent = 'Loading referral statusâ€¦';

  // try to fetch player's referral
  let resp = await api('/player/referral','GET');
  let refCode = resp?.refCode || null;

  // fallback: init client to get referralCode
  if(!refCode){
    const init = await api('/client/init','POST',{});
    refCode = init?.referralCode || null;
  }

  if(refCode){
    const link = buildMiniAppLink(refCode);
    document.getElementById('refLink').value = link;
    document.getElementById('status').innerHTML =
      `Referrals active: ${resp?.count || 0}`;
  }else{
    document.getElementById('refLink').value = 'Unavailable';
    document.getElementById('status').textContent = 'Referral unavailable';
  }
}

/* ================= COPY (clipboard) ================= */

async function copyToClipboard(text){
  // prefer modern API
  if(navigator.clipboard && navigator.clipboard.writeText){
    await navigator.clipboard.writeText(text);
    return true;
  }
  // fallback - select input and execCommand
  const input = document.getElementById('refLink');
  const prevReadOnly = input.readOnly;
  try{
    input.readOnly = false;       // temporarily allow selection on some browsers
    input.focus();
    input.select();

    // For mobile where select() might not select, create a temporary textarea
    const ta = document.createElement('textarea');
    ta.value = text;
    // position off-screen
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.select();

    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    return ok;
  }catch(e){
    console.warn('copy fallback failed', e);
    return false;
  }finally{
    input.readOnly = prevReadOnly;
  }
}

/* ================= EVENTS ================= */

document.addEventListener('DOMContentLoaded',()=>{

  // load referral data
  loadReferral();

  // Back button
  document.getElementById('backBtn').addEventListener('click', (ev)=>{
    ev.preventDefault();
    window.location.href = 'index.html';
  });

  // Copy button
  document.getElementById('copyBtn').addEventListener('click', async (ev)=>{
    ev.preventDefault();
    const url = document.getElementById('refLink').value;
    if(!url || url === 'Unavailable'){ showToast('No referral link'); return; }

    try{
      const ok = await copyToClipboard(url);
      if(ok){
        showToast('Copied to clipboard');
      }else{
        showToast('Copy failed â€” select & copy manually');
      }
    }catch(err){
      console.warn(err);
      showToast('Copy failed');
    }
  });

  // Share button
  document.getElementById('shareBtn').addEventListener('click', async (ev)=>{
    ev.preventDefault();
    const url = document.getElementById('refLink').value;
    if(!url || url === 'Unavailable'){ showToast('No referral link'); return; }

    try{
      // Telegram Web App native link open
      if(window.Telegram?.WebApp){
        const tg = window.Telegram.WebApp;
        // try the standard API variants in order of likelihood
        if(typeof tg.openTelegramLink === 'function'){
          tg.openTelegramLink(url);
          return;
        }else if(typeof tg.openUrl === 'function'){
          // openUrl is commonly present
          tg.openUrl(url);
          return;
        }else{
          // fallback to opening in new window/tab
          window.open(url, '_blank');
          return;
        }
      }

      // Browser native share API
      if(navigator.share){
        await navigator.share({
          title:'Join Hexon',
          text:'Join me on Hexon â€” open in Telegram Mini App',
          url: url
        });
        return;
      }

      // final fallback: copy to clipboard and tell user to paste
      const ok = await copyToClipboard(url);
      if(ok){
        showToast('Link copied â€” paste to share');
      }else{
        alert('Copy and share manually: ' + url);
      }

    }catch(e){
      console.warn('share failed', e);
      // fallback copy attempt
      try{
        const ok2 = await copyToClipboard(url);
        if(ok2) showToast('Link copied â€” paste to share');
        else alert('Share failed â€” copy link manually: ' + url);
      }catch(_){
        alert('Share failed â€” copy link manually: ' + url);
      }
    }
  });

});
</script>
</body>
</html>
