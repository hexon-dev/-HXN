<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hexon — Referrals</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{ font-family:'Orbitron',sans-serif; background:#071027; color:#E6F7FF; margin:0; padding:18px; }
    .card{ background:rgba(255,255,255,0.03); padding:18px; border-radius:12px; max-width:820px; margin:12px auto; }
    .muted{ color:#9fcbdc; font-size:13px; }
    .button{ padding:10px 14px; border-radius:8px; background:linear-gradient(90deg,#3b82f6,#22d3ee); color:#021125; font-weight:700; border:0; cursor:pointer; }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:#7EE7FF; padding:8px 12px; border-radius:8px; cursor:pointer; }
    nav{ margin-bottom:8px; display:flex; gap:8px; }
    nav a{ color:inherit; text-decoration:none; padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); font-weight:600; }
    input[type="text"]{ width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; box-sizing:border-box; }
  </style>
</head>
<body>
  <nav>
    <a href="index.html"><i class="fa-solid fa-gamepad"></i> Game</a>
    <a href="shop.html"><i class="fa-solid fa-mining"></i> Miners</a>
    <a href="leaderboard.html"><i class="fa-solid fa-ranking-star"></i> Leaderboard</a>
    <a href="referrals.html"><i class="fa-solid fa-user-plus"></i> Referrals</a>
  </nav>

  <div class="card">
    <h2>Invite friends</h2>
    <p class="muted">Share the referral link below. When a friend signs up with your code both of you may receive rewards.</p>

    <div style="margin-top:12px;">
      <label class="muted">Your referral link</label>
      <input id="refLink" type="text" readonly />
    </div>

    <div style="display:flex; gap:8px; margin-top:12px;">
      <button id="copyBtn" class="button"><i class="fa-solid fa-copy"></i> Copy link</button>
      <button id="shareBtn" class="btn-ghost"><i class="fa-solid fa-share-nodes"></i> Share</button>
      <button id="closeBtn" class="btn-ghost" onclick="window.location.href='index.html'"><i class="fa-solid fa-arrow-left"></i> Back</button>
    </div>

    <div id="status" style="margin-top:12px;" class="muted">Loading referral status…</div>
  </div>

<script>
const API_BASE = 'https://unfelt-conner-similarly.ngrok-free.dev';
let clientState = { sessionId: localStorage.getItem('hexon_session') || null, username: null, telegramId: null };

function api(path, method='GET', body=null){
  return (async ()=>{
    try {
      let url = API_BASE + path;
      if (method.toUpperCase() === 'GET' && clientState.sessionId){ url += (url.includes('?') ? '&' : '?') + 'sessionId=' + encodeURIComponent(clientState.sessionId); }
      const headers = { 'Content-Type': 'application/json' };
      if (clientState.sessionId) headers['X-Session-Id'] = clientState.sessionId;
      const userHandle = clientState.username ? clientState.username : (clientState.telegramId ? ('tg_' + clientState.telegramId) : null);
      if (userHandle) headers['X-User-Handle'] = userHandle;
      const opts = { method, headers };
      if (body && typeof body === 'object'){ body.username = body.username || clientState.username || null; body.telegramId = body.telegramId || clientState.telegramId || null; body.sessionId = body.sessionId || clientState.sessionId || null; opts.body = JSON.stringify(body); }
      const res = await fetch(url, opts);
      const txt = await res.text();
      try{ return txt ? JSON.parse(txt) : null; } catch(e){ return txt; }
    } catch(e){ console.warn(e); return null; }
  })();
}

function initTelegram(){
  try {
    if (window.Telegram && window.Telegram.WebApp){
      const tg = window.Telegram.WebApp;
      try{ if (typeof tg.ready === 'function') tg.ready(); } catch(e){}
      const u = (tg.initDataUnsafe && tg.initDataUnsafe.user) || (tg.initData && tg.initData.user) || null;
      if (u){
        clientState.telegramId = u.id;
        clientState.username = u.username || `${u.first_name || ''} ${u.last_name || ''}`.trim() || null;
      }
    }
  } catch(e){ console.warn(e); }
}

function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

async function loadReferral(){
  initTelegram();
  // send username to backend so it can identify the account server-side
  const resp = await api('/player/referral','GET');
  let refCode = null;
  try { if (resp && resp.refCode) refCode = resp.refCode; } catch(e){}
  if (!refCode){
    // fallback or show placeholder — request a fresh init if possible
    document.getElementById('status').innerText = 'No referral code available yet.';
    const init = await api('/client/init','POST',{ sessionId: clientState.sessionId, username: clientState.username, telegramId: clientState.telegramId });
    if (init && init.referralCode) refCode = init.referralCode;
  }
  if (refCode){
    const link = `${location.origin}${location.pathname}?ref=${encodeURIComponent(refCode)}`;
    document.getElementById('refLink').value = link;
    document.getElementById('status').innerHTML = `<div>Referrals active: ${escapeHtml(String((resp && resp.count) || 0))}</div>`;
  } else {
    document.getElementById('refLink').value = 'Unavailable';
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadReferral();

  document.getElementById('copyBtn').addEventListener('click', async ()=>{
    try { await navigator.clipboard.writeText(document.getElementById('refLink').value); alert('Copied'); } catch(e){ alert('Copy failed'); }
  });

  document.getElementById('shareBtn').addEventListener('click', async ()=>{
    try {
      if (navigator.share) await navigator.share({ title: 'Join Hexon', text: 'Join me on Hexon', url: document.getElementById('refLink').value });
      else alert('Share not supported — copy the link.');
    } catch(e){}
  });
});
</script>
</body>
</html>
