<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hexon — Leaderboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{ font-family:'Orbitron',sans-serif; background:#071027; color:#E6F7FF; margin:0; padding:18px; }
    .card{ background:rgba(255,255,255,0.03); padding:18px; border-radius:12px; max-width:820px; margin:12px auto; }
    .entry{ display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,0.03); }
    .rank{ width:40px; }
    nav{ margin-bottom:8px; display:flex; gap:8px; }
    nav a{ color:inherit; text-decoration:none; padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); font-weight:600; }
    .button{ padding:8px 12px; border-radius:8px; background:linear-gradient(90deg,#3b82f6,#22d3ee); color:#021125; font-weight:700; border:0; cursor:pointer; }
  </style>
</head>
<body>
  <nav>
    <a href="index.html"><i class="fa-solid fa-gamepad"></i> Game</a>
    <a href="shop.html"><i class="fa-solid fa-mining"></i> Miners</a>
    <a href="leaderboard.html"><i class="fa-solid fa-ranking-star"></i> Leaderboard</a>
    <a href="referrals.html"><i class="fa-solid fa-user-plus"></i> Referrals</a>
  </nav>

  <div class="card">
    <h2>Top Scorers</h2>
    <p class="muted">Live leaderboard — updated periodically.</p>

    <div id="list" style="margin-top:12px;">
      <div class="muted">Loading leaderboard…</div>
    </div>

    <div style="margin-top:12px;">
      <button id="refreshBtn" class="button"><i class="fa-solid fa-arrows-rotate"></i> Refresh</button>
      <button onclick="window.location.href='index.html'" class="button" style="margin-left:8px"><i class="fa-solid fa-arrow-left"></i> Back</button>
    </div>
  </div>

<script>
const API_BASE = 'https://unfelt-conner-similarly.ngrok-free.dev';
let clientState = { sessionId: localStorage.getItem('hexon_session') || null, username: null, telegramId: null };

function api(path, method='GET', body=null){
  return (async ()=>{
    try {
      let url = API_BASE + path;
      if (method.toUpperCase() === 'GET' && clientState.sessionId){ url += (url.includes('?') ? '&' : '?') + 'sessionId=' + encodeURIComponent(clientState.sessionId); }
      const headers = { 'Content-Type': 'application/json' };
      if (clientState.sessionId) headers['X-Session-Id'] = clientState.sessionId;
      const userHandle = clientState.username ? clientState.username : (clientState.telegramId ? ('tg_' + clientState.telegramId) : null);
      if (userHandle) headers['X-User-Handle'] = userHandle;
      const opts = { method, headers };
      if (body && typeof body === 'object'){ body.username = body.username || clientState.username || null; body.telegramId = body.telegramId || clientState.telegramId || null; body.sessionId = body.sessionId || clientState.sessionId || null; opts.body = JSON.stringify(body); }
      const res = await fetch(url, opts);
      const txt = await res.text();
      try{ return txt ? JSON.parse(txt) : null; } catch(e){ return txt; }
    } catch(e){ console.warn(e); return null; }
  })();
}

function initTelegram(){
  try {
    if (window.Telegram && window.Telegram.WebApp){
      const tg = window.Telegram.WebApp;
      try{ if (typeof tg.ready === 'function') tg.ready(); } catch(e){}
      const u = (tg.initDataUnsafe && tg.initDataUnsafe.user) || (tg.initData && tg.initData.user) || null;
      if (u){
        clientState.telegramId = u.id;
        clientState.username = u.username || `${u.first_name || ''} ${u.last_name || ''}`.trim() || null;
      }
    }
  } catch(e){ console.warn(e); }
}

function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

async function refresh(){
  initTelegram();
  const top = await api('/leaderboard/top','GET');
  const container = document.getElementById('list');
  container.innerHTML = '';
  if (!top || !Array.isArray(top) || top.length === 0){ container.innerHTML = '<div class="muted">Leaderboard unavailable</div>'; return; }
  top.forEach((t,idx)=>{
    const row = document.createElement('div'); row.className='entry';
    row.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div class="rank">${idx+1}</div><div>${escapeHtml(t.name || '—')}</div></div><div>${(t.score!=null)?Number(t.score).toLocaleString():'—'}</div>`;
    container.appendChild(row);
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  refresh();
  document.getElementById('refreshBtn').addEventListener('click', refresh);
  setInterval(refresh, 15000);
});
</script>
</body>
</html>
