<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hexon — HXN Grid Activation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg-top: #071027;
      --bg-btm: #000;
      --panel-bg: rgba(8,18,36,0.9);
      --muted: #bfeafc;
      --accent-from: #3b82f6;
      --accent-to: #22d3ee;
      --card-bg: rgba(255,255,255,0.03);
    }

    html,body{
      height:100%;
      margin:0;
      font-family:'Orbitron',sans-serif;
      background: radial-gradient(circle at top,var(--bg-top),var(--bg-btm));
      color:#E6F7FF;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color:transparent;
      -webkit-touch-callout:none;
      box-sizing:border-box;
    }

    /* Layout */
    #gameContainer{ display:flex; gap:12px; padding:12px; height:100dvh; box-sizing:border-box; }
    @supports not (height: 100dvh) { #gameContainer { height:100vh; } }

    #phaserCanvas{ flex:2; display:flex; align-items:center; justify-content:center; min-width:320px; border-radius:12px; overflow:hidden; }
    #uiPanel{ flex:1; min-width:320px; max-width:420px; padding:14px; background: linear-gradient(180deg,var(--panel-bg), rgba(3,6,12,0.8)); border-left:1px solid rgba(255,255,255,0.04); border-radius:12px; overflow:auto; box-sizing:border-box; }

    .card{ background:var(--card-bg); padding:12px; border-radius:12px; margin-bottom:12px; box-shadow:0 6px 18px rgba(0,0,0,0.5); }
    .muted{ color:var(--muted); opacity:.8; font-size:12px; }
    .stat{ font-size:20px; font-weight:700; color:#7EE7FF; }
    .small{ font-size:13px; }
    .small-muted{ font-size:12px; color:#9fcbdc; opacity:.95; }

    .energyBar{ width:100%; height:12px; background:#0f2433; border-radius:8px; overflow:hidden; margin-top:8px; }
    .energyFill{ height:100%; width:60%; background:linear-gradient(90deg,var(--accent-to),var(--accent-from)); transition:width .25s ease; }

    .button{ display:inline-block; padding:8px 12px; border-radius:8px; background:linear-gradient(90deg,var(--accent-from),var(--accent-to)); color:#021125; font-weight:700; cursor:pointer; border:0; user-select:none; }
    .btn-ghost{ background:transparent; border:1px solid rgba(126,231,255,0.12); color:#7EE7FF; padding:8px 12px; border-radius:8px; cursor:pointer; }

    input[type="text"]{ background:transparent; border:1px solid rgba(255,255,255,0.06); padding:8px; border-radius:8px; width:100%; color:inherit; box-sizing:border-box; }

    .wallet-option{ display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:10px; cursor:pointer; user-select:none; }
    .wallet-option:hover{ background:rgba(255,255,255,0.02); }

    /* bottom-sheet overlay (used inline) */
    .overlay{ position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; z-index:99999; background:rgba(0,0,0,0.45); padding:env(safe-area-inset-top,12px) 12px calc(env(safe-area-inset-bottom,12px) + 6px); box-sizing:border-box; }
    .overlay.show{ display:flex; }

    .bottom-sheet{
      width:100%;
      max-width:720px;
      border-radius:14px;
      background:linear-gradient(180deg,#071423,#03101a);
      box-shadow:0 20px 60px rgba(0,0,0,0.6);
      transform:translateY(0);
      transition:transform .22s cubic-bezier(.2,.9,.3,1);
      overflow:hidden;
      max-height: min(86vh, calc(100vh - 96px));
      display:flex;
      flex-direction:column;
    }

    .sheet-header{ padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.02); display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .sheet-title{ font-weight:700; font-size:16px; color:#E6F7FF; }
    .sheet-body{ padding:12px 16px; overflow:auto; -webkit-overflow-scrolling:touch; max-height:60vh; }
    .sheet-actions{ padding:12px 16px; border-top:1px solid rgba(255,255,255,0.02); display:flex; gap:8px; justify-content:flex-end; background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent); }

    /* minimal toast (non-modal) */
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      background: rgba(3,10,18,0.85);
      color: #E6F7FF;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      font-size: 13px;
      z-index: 100000;
      display: none;
    }

    @media (max-width:900px){
      #gameContainer{ flex-direction:column; padding:10px; }
      #phaserCanvas{ order:1; height:56dvh; min-height:320px; }
      #uiPanel{ order:2; height:44dvh; min-height:180px; }
      .bottom-sheet{ max-height:88vh; border-radius:12px 12px 0 0; }
    }
  </style>
</head>
<body>

<div id="gameContainer" role="application" aria-label="Hexon game">
  <div id="phaserCanvas" role="region" aria-label="Game canvas"></div>

  <aside id="uiPanel" aria-live="polite" role="complementary" aria-label="Game controls and stats">
    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div class="muted small">Player</div>
        <div class="stat small" id="ui-username">Guest</div>
        <div style="height:6px"></div>
        <div class="muted small">Wallet</div>
        <div class="small" id="ui-wallet">Not connected</div>
      </div>
      <div style="text-align:right;">
        <div class="muted small">Session</div>
        <div class="small" id="ui-session">—</div>
        <div style="height:6px"></div>
        <div class="muted small">Provider</div>
        <div class="small" id="ui-provider">—</div>
      </div>
    </div>

    <div class="card">
      <div class="small muted">Level</div>
      <div class="stat" id="ui-level">1</div>
      <div style="display:flex; gap:12px; margin-top:8px; align-items:center;">
        <div>
          <div class="muted small">Lines</div>
          <div class="small" id="ui-lines">0</div>
        </div>
        <div style="margin-left:auto; text-align:right;">
          <div class="muted small">Score</div>
          <div class="stat" id="ui-score">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="muted small">GP</div>
          <div id="ui-gp" class="small">0 GP</div>
        </div>
        <div>
          <button id="bindWalletBtn" class="button" type="button" aria-label="Bind wallet">Bind Wallet</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="flex:1">
          <div class="small muted">Energy</div>
          <div class="energyBar"><div id="ui-energyFill" class="energyFill"></div></div>
        </div>
        <div style="text-align:right; width:120px;">
          <div class="muted small">Auto Refill</div>
          <div class="small" id="ui-auto">+10% / 30m</div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; margin-top:8px;">
        <div>
          <div class="muted small">Sittings Left</div>
          <div class="small" id="ui-sittings">3/3</div>
        </div>
        <div>
          <div class="muted small">Ads Today</div>
          <div class="small" id="ui-adsToday">0</div>
        </div>
      </div>

      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="watchAdBtn" class="button">Watch Transmission</button>
        <button id="showRefBtn" class="btn-ghost">Share Referral</button>
      </div>
    </div>

    <div class="card">
      <div class="small muted">Miners (Off-chain)</div>
      <div id="minersList" class="small" aria-live="polite" style="margin-top:8px;">
        <div class="muted small">Loading…</div>
      </div>
      <div style="margin-top:8px;">
        <button id="openStore" class="button">Open Miner Shop</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="small muted">Claimable HXN (preview)</div>
          <div class="stat" id="ui-hxn">0 HXN</div>
        </div>
        <div style="text-align:right;">
          <div class="muted small">Hash Units</div>
          <div class="small" id="ui-au">AU: 0</div>
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="viewAlloc" class="btn-ghost">View Allocation</button>
        <button id="claimRewardBtn" class="button">Claim & Close</button>
      </div>
    </div>

    <div class="card">
      <div class="small muted">Top Scorers</div>
      <div class="leaderboard" id="leaderboard" aria-live="polite" style="margin-top:8px;">
        <div class="muted small">Loading…</div>
      </div>
    </div>

    <div class="card">
      <div class="small muted">Daily Missions</div>
      <div class="small" id="missions" style="margin-top:8px;">- Clear 50 lines<br>- Play 3 games today<br>- Invite friend (referral)</div>
    </div>

    <div class="footer muted small">Pre-launch • Season active • <span id="daysLeft">74</span> days left</div>
  </aside>
</div>

<!-- overlay bottom-sheet for wallet picker + all inline dialogs -->
<div id="overlay" class="overlay" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="bottom-sheet" role="document" aria-label="Inline sheet">
    <div class="sheet-header">
      <div class="sheet-title">Connect Wallet</div>
      <div>
        <button id="sheetClose" class="btn-ghost" aria-label="Close sheet">Close</button>
      </div>
    </div>

    <div class="sheet-body" id="sheetBody" tabindex="0">
      <!-- default wallet content (main.js may overwrite sheetBody innerHTML when used) -->
      <div class="small-muted" style="margin-bottom:10px">Choose a wallet or paste your public key. In the Telegram mini app we open deep-links using the WebApp API when available.</div>

      <div class="wallet-option" id="opt-phantom" tabindex="0" role="button" aria-pressed="false">
        <div>Phantom</div><div class="small-muted" id="det-phantom"></div>
      </div>

      <div class="wallet-option" id="opt-solflare" tabindex="0" role="button" aria-pressed="false">
        <div>Solflare</div><div class="small-muted" id="det-solflare"></div>
      </div>

      <div class="wallet-option" id="opt-backpack" tabindex="0" role="button" aria-pressed="false">
        <div>Backpack</div><div class="small-muted" id="det-backpack"></div>
      </div>

      <div class="wallet-option" id="opt-wc" tabindex="0" role="button" aria-pressed="false">
        <div>WalletConnect</div><div class="small-muted">Use a compatible mobile wallet</div>
      </div>

      <div style="height:12px"></div>

      <div class="small-muted">Manual public key</div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <input id="manualPublicKey" type="text" inputmode="text" placeholder="Paste public key here" aria-label="Public key" />
        <button id="manualBindBtn" class="button" type="button">Bind</button>
      </div>
    </div>

    <div class="sheet-actions" id="sheetActions">
      <button id="sheetCancel" class="btn-ghost" type="button">Cancel</button>
    </div>
  </div>
</div>

<!-- toast (non-modal) -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- bottom-sheet helper (keeps behavior aligned with main.js) -->
<script>
(function(){
  function tgInstance(){ try{ return (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null; }catch(e){return null;} }
  function openExternal(url){
    const tg = tgInstance();
    if (tg){
      try {
        if (typeof tg.openUrl === 'function'){ tg.openUrl(url); return; }
        if (typeof tg.openLink === 'function'){ tg.openLink(url); return; }
        if (typeof tg.openPopup === 'function'){ tg.openPopup(url); return; }
      } catch(e){ console.warn('tg.open* failed', e); }
    }
    try { window.location.assign(url); } catch(e){ try { window.open(url, '_blank'); } catch(e2){ console.warn('openExternal fallback failed', e2); } }
  }

  const overlay = document.getElementById('overlay');
  const sheetClose = document.getElementById('sheetClose');
  const sheetCancel = document.getElementById('sheetCancel');
  const bindBtn = document.getElementById('bindWalletBtn');
  const sheetBody = document.getElementById('sheetBody');
  const sheetTitle = document.querySelector('.sheet-title');
  const sheetActions = document.getElementById('sheetActions');

  function showSheet(opts = {}) {
    // opts: { title, bodyHtml, actionsHtml, onMounted }
    if (!overlay) return;
    if (opts.title !== undefined && sheetTitle) sheetTitle.textContent = opts.title;
    if (opts.bodyHtml !== undefined && sheetBody) sheetBody.innerHTML = opts.bodyHtml;
    if (opts.actionsHtml !== undefined && sheetActions) sheetActions.innerHTML = opts.actionsHtml;
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    try { const tg = tgInstance(); if (tg && typeof tg.expand === 'function') tg.expand(); } catch(e){}
    try { if (sheetBody) sheetBody.focus(); } catch(e){}
    if (typeof opts.onMounted === 'function') {
      setTimeout(()=> { try { opts.onMounted(); } catch(e){ console.warn('sheet onMounted failed', e); } }, 50);
    }
    // ensure detection badges updated when showing sheet
    setDetectionBadges();
  }

  function hideSheet(){
    if (!overlay) return;
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
  }

  function setDetectionBadges(){
    const d = detectInjectedProviders();
    try {
      document.getElementById('det-phantom').textContent = d.phantom ? '• detected' : '';
      document.getElementById('det-solflare').textContent = d.solflare ? '• detected' : '';
      document.getElementById('det-backpack').textContent = d.backpack ? '• detected' : '';
    } catch(e){}
  }

  function buildCleanRedirect(){
    try { return window.location.origin.replace(/\/+$/,'') + window.location.pathname; } catch(e){ return window.location.origin + '/'; }
  }
  function phantomDeepLink(){
    const origin = encodeURIComponent(window.location.origin.replace(/\/+$/,''));
    const redirect = encodeURIComponent(buildCleanRedirect());
    return `https://phantom.app/ul/v1/connect?app_url=${origin}&redirect_link=${redirect}`;
  }
  function solflareDeepLink(){
    const redirect = encodeURIComponent(buildCleanRedirect());
    return `https://solflare.com/access?redirect=${redirect}`;
  }
  function backpackDeepLink(){ return 'https://backpack.app/'; }

  function detectInjectedProviders(){
    return {
      phantom: Boolean(window.solana && window.solana.isPhantom),
      solflare: Boolean(window.solflare || (window.solana && window.solana.isSolflare)),
      backpack: Boolean(window.backpack || (window.solana && window.solana.isBackpack))
    };
  }

  // optionMap calls into main.js helpers if available (preferred)
  const optionMap = {
    'opt-phantom': async ()=> {
      if (typeof window.connectWithPhantom === 'function') {
        try { await window.connectWithPhantom(); hideSheet(); return; } catch(e){ console.warn('connectWithPhantom failed', e); }
      }
      openExternal(phantomDeepLink());
    },
    'opt-solflare': async ()=> {
      if (typeof window.connectWithSolflare === 'function') {
        try { await window.connectWithSolflare(); hideSheet(); return; } catch(e){ console.warn('connectWithSolflare failed', e); }
      }
      openExternal(solflareDeepLink());
    },
    'opt-backpack': async ()=> {
      if (typeof window.connectWithBackpack === 'function') {
        try { await window.connectWithBackpack(); hideSheet(); return; } catch(e){ console.warn('connectWithBackpack failed', e); }
      }
      openExternal(backpackDeepLink());
    },
    'opt-wc': async ()=> {
      if (typeof window.connectWithWalletConnect === 'function') {
        try { await window.connectWithWalletConnect(); hideSheet(); return; } catch(e){ console.warn('connectWithWalletConnect failed', e); alert('WalletConnect attempt failed'); return; }
      }
      const tg = tgInstance();
      if (tg) {
        const msg = 'Open your mobile wallet (Coinbase Wallet / Trust Wallet / Exodus) and choose WalletConnect. Then paste the returned public key into Hexon.';
        alert(msg);
      } else {
        alert('Open your wallet app and choose WalletConnect, or use a WalletConnect-enabled wallet.');
      }
    }
  };

  async function manualBind(publicKey){
    if (!publicKey || publicKey.length < 20){ alert('Invalid public key'); return; }
    if (typeof window.finalizeBind === 'function'){
      try {
        const ok = await window.finalizeBind(publicKey, 'manual');
        if (ok) hideSheet();
        return;
      } catch(e){ console.warn('finalizeBind failed', e); alert('Server bind failed'); return; }
    }
    try {
      localStorage.setItem('hexon_bound_wallet', publicKey);
      localStorage.setItem('hexon_bound_provider', 'manual');
      const wEl = document.getElementById('ui-wallet');
      const pEl = document.getElementById('ui-provider');
      if (wEl) wEl.textContent = publicKey;
      if (pEl) pEl.textContent = 'manual';
      hideSheet();
      showToast('Public key stored locally (no server bind performed).', 2000);
    } catch(e){ console.warn(e); alert('Unable to save locally'); }
  }

  function interceptBind(ev){
    ev.preventDefault();
    ev.stopImmediatePropagation();
    if (typeof window._hexon_openWalletSheet === 'function'){ try { window._hexon_openWalletSheet(); return false; } catch(e){} }
    // default: show the inline sheet (wallet content already present in DOM)
    showSheet({ title: 'Connect Wallet', bodyHtml: sheetBody.innerHTML, onMounted: ()=>{} });
    return false;
  }

  function onKeyDown(e){
    if (e.key === 'Escape' && overlay.classList.contains('show')){ hideSheet(); }
  }

  // toast helper
  const toastEl = document.getElementById('toast');
  function showToast(msg, ms = 2000){
    if (!toastEl) return;
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    setTimeout(()=> { try { toastEl.style.display = 'none'; } catch(e){} }, ms);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // Bind button interception (keeps index.html UI binding consistent)
    if (bindBtn){
      bindBtn.addEventListener('pointerdown', interceptBind, { capture:true, passive:false });
      bindBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopImmediatePropagation(); if (typeof window._hexon_openWalletSheet === 'function'){ try { window._hexon_openWalletSheet(); return; } catch(e){} } showSheet({ title: 'Connect Wallet', bodyHtml: sheetBody.innerHTML }); }, { passive:false });
      bindBtn.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showSheet({ title: 'Connect Wallet', bodyHtml: sheetBody.innerHTML }); } });
    }

    if (sheetClose) sheetClose.addEventListener('click', hideSheet);
    if (sheetCancel) sheetCancel.addEventListener('click', hideSheet);

    overlay.addEventListener('pointerdown', (ev)=>{ if (ev.target === overlay) hideSheet(); });

    Object.keys(optionMap).forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('pointerdown', async (ev)=>{ ev.preventDefault(); ev.stopPropagation(); try { await optionMap[id](); } catch(e){ console.warn(e); showToast('Connection failed', 1200); } }, { passive:false });
      el.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); optionMap[id](); } });
    });

    const manualBtn = document.getElementById('manualBindBtn');
    if (manualBtn){
      manualBtn.addEventListener('pointerdown', async (ev)=>{ ev.preventDefault(); ev.stopPropagation(); const pk = (document.getElementById('manualPublicKey').value||'').trim(); await manualBind(pk); }, { passive:false });
    }

    setDetectionBadges();
    try {
      const sid = localStorage.getItem('hexon_session');
      if (sid && document.getElementById('ui-session')) document.getElementById('ui-session').textContent = sid;
      const wallet = localStorage.getItem('hexon_bound_wallet');
      if (wallet && document.getElementById('ui-wallet')) document.getElementById('ui-wallet').textContent = wallet;
      const prov = localStorage.getItem('hexon_bound_provider');
      if (prov && document.getElementById('ui-provider')) document.getElementById('ui-provider').textContent = prov;
    } catch(e){}

    document.addEventListener('keydown', onKeyDown);
  });

  // expose helpers so main.js can call into this sheet
  window._hexon_openWalletSheet = ()=> showSheet({ title: 'Connect Wallet', bodyHtml: sheetBody.innerHTML });
  window._hexon_closeWalletSheet = hideSheet;
  window._hexon_showSheet = showSheet;   // generic
  window._hexon_hideSheet = hideSheet;
  window._hexon_showToast = (m,t)=> showToast(m,t);
})();
</script>

<!-- phaser lib (deferred) -->
<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js" defer></script>

<!-- main game file (deferred) -->
<script src="./main.js" defer></script>
</body>
</html>
