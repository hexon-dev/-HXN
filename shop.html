<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hexon — Miner Shop</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#071027;
      --card-bg: rgba(255,255,255,0.03);
      --muted:#9fcbdc;
      --accent-from:#3b82f6;
      --accent-to:#22d3ee;
    }
    html,body{ height:100%; margin:0; font-family:'Orbitron',sans-serif; background:var(--bg); color:#E6F7FF; -webkit-font-smoothing:antialiased; box-sizing:border-box; padding:18px; }
    nav{ margin-bottom:12px; display:flex; gap:8px; flex-wrap:wrap; }
    nav a{ color:inherit; text-decoration:none; padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); font-weight:600; display:inline-flex; gap:8px; align-items:center;}
    .container{ max-width:1100px; margin:0 auto; }
    .card{ background:var(--card-bg); padding:18px; border-radius:12px; margin-bottom:14px; }
    .card h2{ margin:0 0 6px 0; }
    .muted{ color:var(--muted); font-size:13px; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:12px; margin-top:12px; }
    .item{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      border-radius:10px; padding:10px; display:flex; flex-direction:column; gap:8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
      min-height: 220px;
    }
    .media{
      width:100%; aspect-ratio: 16 / 9; overflow:hidden; border-radius:8px; display:flex; align-items:center; justify-content:center; background:#041123;
    }
    .media img{ width:100%; height:100%; object-fit:cover; display:block; }
    .meta{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:6px; }
    .meta-left{ max-width:70%; }
    .name{ font-weight:800; font-size:15px; margin-bottom:6px; }
    .desc{ font-size:13px; color:var(--muted); line-height:1.2; }
    .price{ font-weight:800; font-size:16px; color:#7EE7FF; }
    .actions{ display:flex; gap:8px; margin-top:auto; align-items:center; }
    .button{ padding:8px 12px; border-radius:8px; background:linear-gradient(90deg,var(--accent-from),var(--accent-to)); color:#021125; font-weight:700; border:0; cursor:pointer; }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:#7EE7FF; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .small{ font-size:13px; }
    .toast{ position: fixed; left: 50%; transform: translateX(-50%); bottom: 18px; background: rgba(3,10,18,0.9); color:#E6F7FF; padding:8px 12px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.4); display:none; z-index:9999; }
    .lightbox{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.85); z-index:99999; padding:18px; box-sizing:border-box; }
    .lightbox.show{ display:flex; }
    .lightbox img{ max-width:100%; max-height:95vh; object-fit:contain; border-radius:8px; box-shadow:0 12px 40px rgba(0,0,0,0.6); }
    @media (max-width:720px){
      .grid{ grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="container">
    <nav aria-label="Main navigation">
      <a href="index.html"><i class="fa-solid fa-gamepad"></i> Game</a>
      <a href="shop.html"><i class="fa-solid fa-mining"></i> Miners</a>
      <a href="leaderboard.html"><i class="fa-solid fa-ranking-star"></i> Leaderboard</a>
      <a href="referrals.html"><i class="fa-solid fa-user-plus"></i> Referrals</a>
      <button id="refreshBtn" class="btn-ghost" style="margin-left:auto"><i class="fa-solid fa-arrows-rotate"></i> Refresh</button>
    </nav>

    <div class="card" role="main" aria-labelledby="shopTitle">
      <h2 id="shopTitle">Miner Shop</h2>
      <p class="muted">Buy miners to increase your Hash Units. If your backend provides `image_url` (image or GIF) it will be displayed and viewable fullscreen.</p>

      <div id="itemsContainer" class="grid" aria-live="polite">
        <div class="muted">Loading items…</div>
      </div>
    </div>
  </div>

  <!-- toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" tabindex="-1" onclick="hideLightbox()">
    <img id="lightboxImg" alt="Preview" />
  </div>

<script>
/* -------------------------
   Config + state
-------------------------*/
const API_BASE = 'https://unfelt-conner-similarly.ngrok-free.dev';
const clientState = {
  sessionId: localStorage.getItem('hexon_session') || generateUUID(),
  username: null,
  telegramId: null
};
localStorage.setItem('hexon_session', clientState.sessionId);

function generateUUID(){ try { if (window.crypto && crypto.randomUUID) return crypto.randomUUID(); } catch(e){} return 'sess-'+Math.floor(Math.random()*1e12).toString(36); }
function $(id){ return document.getElementById(id); }
function showToast(msg, ms = 2000){ const t = $('toast'); if (!t) return; t.textContent = msg; t.style.display = 'block'; setTimeout(()=> t.style.display = 'none', ms); }
function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* -------------------------
   API helper (adds headers + body fields)
-------------------------*/
async function api(path, method='GET', body=null, optsExtra={}) {
  try {
    let url = API_BASE + path;
    if (method.toUpperCase() === 'GET' && clientState.sessionId){
      if (!url.includes('sessionId=')) url += (url.includes('?') ? '&' : '?') + 'sessionId=' + encodeURIComponent(clientState.sessionId);
    }

    const headers = Object.assign({}, optsExtra.headers || {});
    if (!optsExtra.skipJsonHeader) headers['Content-Type'] = headers['Content-Type'] || 'application/json';
    if (clientState.sessionId) headers['X-Session-Id'] = clientState.sessionId;
    const userHandle = clientState.username ? clientState.username : (clientState.telegramId ? ('tg_' + clientState.telegramId) : null);
    if (userHandle) headers['X-User-Handle'] = userHandle;

    const fetchOpts = { method, headers, ...optsExtra };
    if (body !== null && body !== undefined){
      if (fetchOpts.headers['Content-Type'] && fetchOpts.headers['Content-Type'].includes('application/json') && typeof body === 'object'){
        body.username = body.username || clientState.username || null;
        body.telegramId = body.telegramId || clientState.telegramId || null;
        body.sessionId = body.sessionId || clientState.sessionId || null;
        fetchOpts.body = JSON.stringify(body);
      } else {
        fetchOpts.body = body;
      }
    }

    const res = await fetch(url, fetchOpts);
    const txt = await res.text();
    try { return txt ? JSON.parse(txt) : null; } catch(e) { return txt; }
  } catch(err) {
    console.warn('api error', err);
    return null;
  }
}

/* -------------------------
   Telegram init (username fallback)
-------------------------*/
function initTelegram(){
  try {
    if (window.Telegram && window.Telegram.WebApp){
      const tg = window.Telegram.WebApp;
      try { if (typeof tg.ready === 'function') tg.ready(); } catch(e){}
      const u = (tg.initDataUnsafe && tg.initDataUnsafe.user) || (tg.initData && tg.initData.user) || null;
      if (u){
        clientState.telegramId = u.id;
        clientState.username = clientState.username || (u.username || `${u.first_name || ''} ${u.last_name || ''}`.trim() || null);
      }
    }
  } catch(e){ console.warn('initTelegram error', e); }
}

/* -------------------------
   Load & render shop (displays images/gifs when provided)
   Expects backend items with optional field: image_url (string)
-------------------------*/
async function loadShop(){
  initTelegram();
  const container = $('itemsContainer');
  container.innerHTML = '<div class="muted">Loading items…</div>';

  const items = await api('/shop/items','GET');
  if (!items || !Array.isArray(items) || items.length === 0){
    container.innerHTML = '<div class="muted">Shop unavailable</div>';
    return;
  }

  container.innerHTML = '';
  for (const it of items){
    const id = escapeHtml(String(it.id || it.sku || ''));
    const name = escapeHtml(it.name || 'Unnamed Miner');
    const desc = escapeHtml(it.description || it.desc || '');
    const price = Number(it.price_gp ?? it.priceGP ?? 0);
    const imageUrl = it.image_url || it.image || null;

    const card = document.createElement('div');
    card.className = 'item';
    const mediaHtml = imageUrl ? `<img loading="lazy" src="${escapeHtml(imageUrl)}" alt="${name}">` : `<div class="muted small">No image</div>`;
    card.innerHTML = `
      <div class="media" role="button" tabindex="0" aria-label="Preview ${name}">${mediaHtml}</div>
      <div class="meta">
        <div class="meta-left">
          <div class="name">${name}</div>
          <div class="desc">${desc}</div>
        </div>
        <div style="text-align:right">
          <div class="price">${price.toLocaleString()} GP</div>
          <div class="small muted" style="margin-top:6px">ID: ${id}</div>
        </div>
      </div>
      <div class="actions">
        <button class="button buyBtn" data-id="${id}"><i class="fa-solid fa-cart-plus"></i> Buy</button>
        <button class="btn-ghost viewBtn" ${imageUrl ? '' : 'disabled'}>${imageUrl ? '<i class="fa-solid fa-eye"></i> View' : '<i class="fa-solid fa-image"></i> No preview'}</button>
      </div>
    `;
    container.appendChild(card);

    // buy handler
    const buyBtn = card.querySelector('.buyBtn');
    buyBtn.addEventListener('click', async () => {
      if (!confirm(`Buy "${name}" for ${price.toLocaleString()} GP?`)) return;
      buyBtn.disabled = true;
      buyBtn.textContent = 'Processing…';
      const resp = await api('/shop/buy','POST',{ sessionId: clientState.sessionId, itemId: id });
      if (resp && resp.ok){
        showToast('Purchase successful', 1200);
        // refresh shop and UI as appropriate
        await loadShop();
      } else {
        showToast((resp && resp.error) ? resp.error : 'Purchase failed', 2100);
        buyBtn.disabled = false;
        buyBtn.innerHTML = '<i class="fa-solid fa-cart-plus"></i> Buy';
      }
    });

    // view (lightbox)
    const viewBtn = card.querySelector('.viewBtn');
    const mediaEl = card.querySelector('.media');
    const openPreview = () => {
      if (!imageUrl) return;
      showLightbox(imageUrl);
    };
    if (viewBtn && imageUrl) viewBtn.addEventListener('click', openPreview);
    if (mediaEl && imageUrl){
      mediaEl.addEventListener('click', openPreview);
      mediaEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') openPreview(); });
    }
  }
}

/* -------------------------
   Lightbox
-------------------------*/
function showLightbox(url){
  const lb = $('lightbox');
  const img = $('lightboxImg');
  img.src = url;
  lb.classList.add('show');
  lb.focus();
}
function hideLightbox(){
  const lb = $('lightbox');
  lb.classList.remove('show');
  $('lightboxImg').src = '';
}
document.addEventListener('keydown', (e)=> { if (e.key === 'Escape') hideLightbox(); });

/* -------------------------
   Wiring & boot
-------------------------*/
$('refreshBtn').addEventListener('click', ()=> loadShop());

document.addEventListener('DOMContentLoaded', ()=>{
  initTelegram();
  loadShop();
});
</script>
</body>
</html>
