<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hexon — Miner Shop</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{ font-family:'Orbitron',sans-serif; background:#071027; color:#E6F7FF; margin:0; padding:18px; }
    .card{ background:rgba(255,255,255,0.03); padding:18px; border-radius:12px; max-width:820px; margin:12px auto; }
    .item{ display:flex; justify-content:space-between; align-items:center; padding:12px; border-top:1px dashed rgba(255,255,255,0.03); }
    .button{ padding:10px 14px; border-radius:8px; background:linear-gradient(90deg,#3b82f6,#22d3ee); color:#021125; font-weight:700; border:0; cursor:pointer; }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:#7EE7FF; padding:8px 12px; border-radius:8px; cursor:pointer; }
    nav{ margin-bottom:8px; display:flex; gap:8px; }
    nav a{ color:inherit; text-decoration:none; padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); font-weight:600; }
  </style>
</head>
<body>
  <nav>
    <a href="index.html"><i class="fa-solid fa-gamepad"></i> Game</a>
    <a href="shop.html"><i class="fa-solid fa-mining"></i> Miners</a>
    <a href="leaderboard.html"><i class="fa-solid fa-ranking-star"></i> Leaderboard</a>
    <a href="referrals.html"><i class="fa-solid fa-user-plus"></i> Referrals</a>
  </nav>

  <div class="card">
    <h2>Miner Shop</h2>
    <p class="muted">Buy miners to increase your Hash Units. Prices shown in GP.</p>

    <div id="items" style="margin-top:12px;">
      <div class="muted">Loading items…</div>
    </div>

    <div style="margin-top:12px;">
      <button onclick="window.location.href='index.html'" class="btn-ghost"><i class="fa-solid fa-arrow-left"></i> Back to game</button>
    </div>
  </div>

<script>
const API_BASE = 'https://unfelt-conner-similarly.ngrok-free.dev';
let clientState = { sessionId: localStorage.getItem('hexon_session') || null, username: null, telegramId: null };

function api(path, method='GET', body=null){
  return (async ()=>{
    try {
      let url = API_BASE + path;
      if (method.toUpperCase() === 'GET' && clientState.sessionId){ url += (url.includes('?') ? '&' : '?') + 'sessionId=' + encodeURIComponent(clientState.sessionId); }
      const headers = { 'Content-Type': 'application/json' };
      if (clientState.sessionId) headers['X-Session-Id'] = clientState.sessionId;
      const userHandle = clientState.username ? clientState.username : (clientState.telegramId ? ('tg_' + clientState.telegramId) : null);
      if (userHandle) headers['X-User-Handle'] = userHandle;
      const opts = { method, headers };
      if (body && typeof body === 'object'){ body.username = body.username || clientState.username || null; body.telegramId = body.telegramId || clientState.telegramId || null; body.sessionId = body.sessionId || clientState.sessionId || null; opts.body = JSON.stringify(body); }
      const res = await fetch(url, opts);
      const txt = await res.text();
      try{ return txt ? JSON.parse(txt) : null; } catch(e){ return txt; }
    } catch(e){ console.warn(e); return null; }
  })();
}

function initTelegram(){
  try {
    if (window.Telegram && window.Telegram.WebApp){
      const tg = window.Telegram.WebApp;
      try{ if (typeof tg.ready === 'function') tg.ready(); } catch(e){}
      const u = (tg.initDataUnsafe && tg.initDataUnsafe.user) || (tg.initData && tg.initData.user) || null;
      if (u){
        clientState.telegramId = u.id;
        clientState.username = u.username || `${u.first_name || ''} ${u.last_name || ''}`.trim() || null;
      }
    }
  } catch(e){ console.warn(e); }
}

function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

async function loadShop(){
  initTelegram();
  const items = await api('/shop/items','GET');
  const container = document.getElementById('items');
  container.innerHTML = '';
  if (!items || !Array.isArray(items) || items.length === 0){ container.innerHTML = '<div class="muted">Shop unavailable</div>'; return; }
  items.forEach(it => {
    const div = document.createElement('div'); div.className = 'item';
    div.innerHTML = `<div><b>${escapeHtml(it.name)}</b><div class="muted" style="margin-top:6px">${escapeHtml(it.description || it.desc || '')}</div></div>
      <div style="text-align:right"><div style="font-weight:700">${(it.price_gp||it.priceGP||0)} GP</div><button class="button buy" data-id="${escapeHtml(String(it.id))}" style="margin-top:8px"><i class="fa-solid fa-cart-plus"></i> Buy</button></div>`;
    container.appendChild(div);
  });

  container.querySelectorAll('.buy').forEach(b => {
    b.onclick = async () => {
      const id = b.getAttribute('data-id');
      if (!confirm('Buy this miner?')) return;
      b.disabled = true;
      b.innerText = 'Purchasing…';
      const resp = await api('/shop/buy','POST',{ sessionId: clientState.sessionId, itemId: id, username: clientState.username, telegramId: clientState.telegramId });
      if (resp && resp.ok){
        alert('Purchase successful');
        window.location.href = 'index.html';
      } else {
        alert((resp && resp.error) ? resp.error : 'Purchase failed');
        b.disabled = false;
        b.innerHTML = '<i class="fa-solid fa-cart-plus"></i> Buy';
      }
    };
  });
}

document.addEventListener('DOMContentLoaded', ()=> loadShop());
</script>
</body>
</html>
